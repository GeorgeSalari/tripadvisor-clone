$(document).ready(function(){
  $('#search_one_flight').click(function(event){
    console.log("hi");
    event.preventDefault();
    $.ajax({
      url: "/flight_respons",
      method: 'post',
      data: jQuery.param({
        origin: $('#origin').val(),
        destination: $('#destination').val(),
        date: $('#date').val(),
        preferredCabin: $('#preferredCabin').val(),
        adultCount: $('#adultCount').val(),
        seniorCount: $('#seniorCount').val(),
        childCount: $('#childCount').val(),
        infantInLapCount: $('#infantInLapCount').val(),
        infantInSeatCount: $('#infantInSeatCount').val(),
        refundable: $('#refundable').is(':checked'),
        solutions: $('#solutions').val()
      }),
      contentType: 'application/x-www-form-urlencoded; charset=UTF-8',
      success: function(data){
        $('#search_result_one_flight').removeClass('hidden');
        $('#search_result_one_flight').append("<h1>Select your flight:</h1>");
        carrier_name = {};
        $.each(data['trips']["data"]['carrier'], function(ind, hash){
          carrier_name[hash['code']] = hash['name'];
        });
        $.each(data['trips']['tripOption'], function(i, h){
          duration = h['slice'][0]['duration'];
          connection = h['slice'][0]['segment'].length - 1;
          days = 0;
          hours = 0;
          minutes = 0;
          while (duration > 0) {
            if (duration >= 1440) {
              days = Math.floor(duration / 60 / 24);
              duration -= days * 24 * 60;
            } else if (duration > 60) {
              hours = Math.floor(duration / 60);
              duration -= hours * 60;
            } else {
              minutes = duration;
              duration -= minutes;
            };
          };
          if (days > 0 && hours > 0 && minutes > 0){
            flight_duration = days+"d "+hours+"h "+minutes+"m";
          } else if (days > 0 && minutes > 0) {
            flight_duration = days+"d 0h "+minutes+"m";
          } else if (days > 0 && hours > 0) {
            flight_duration = days+"d "+hours+"h 0m";
          } else if (days > 0) {
            flight_duration = days+"d 0h 0m";
          } else if (hours > 0 && minutes > 0) {
            flight_duration = hours+"h "+minutes+"m";
          } else if (minutes > 0) {
            flight_duration = minutes+"m";
          };

          total_price = h['saleTotal'];
          flight_departure = new Date(h['slice'][0]['segment'][0]['leg'][0]["departureTime"]);
          flight_departure_time = flight_departure.toLocaleTimeString().slice(0, -3);
          flight_departure_date = flight_departure.toLocaleDateString();
          flight_arrival = new Date(h['slice'][0]['segment'][0]['leg'][0]["arrivalTime"]);
          flight_arrival_time = flight_arrival.toLocaleTimeString().slice(0, -3);
          flight_arrival_date = flight_arrival.toLocaleDateString();
          origin = h['slice'][0]['segment'][0]['leg'][0]["origin"];
          if (connection == 0){
            stops = "Direct";
            flight_number = h['slice'][0]['segment'][0]['flight']['number'];
            carrier_code = h['slice'][0]['segment'][0]['flight']['carrier'];
            destination = h['slice'][0]['segment'][0]['leg'][0]["destination"];
            this_carrier_name = carrier_name[carrier_code];
            $('#search_result_one_flight').append("<div id='one_result_"+i+"' class='one_result'></div>");
            $('#one_result_'+i).append("<div id='time_"+i+"'></div>");
            $('#time_'+i).append("<p>"+flight_departure_time+" - "+flight_arrival_time+"</p><p>"+this_carrier_name+"</p>");
            $('#one_result_'+i).append("<div id='duration_"+i+"'></div>");
            $('#duration_'+i).append("<p>"+flight_duration+"</p><p>"+origin+" - "+destination+"</p>");
            $('#one_result_'+i).append("<div id='stops_"+i+"'></div>");
            $('#stops_'+i).append("<p>"+stops+"</p><p>"+carrier_code+" "+flight_number+"</p>");
            $('#one_result_'+i).append("<div id='price_"+i+"'></div>");
            $('#price_'+i).append("<p>"+total_price+"</p>");
          } else if (connection == 1){
            stops = connection+" stops";
            $('#search_result_one_flight').append("<div id='one_result_"+i+"' class='one_result'></div>");
            $('#one_result_'+i).append("<div id='time_"+i+"'></div>");
            $('#one_result_'+i).append("<div id='duration_"+i+"'></div>");
            $('#one_result_'+i).append("<div id='stops_"+i+"'></div>");
            $('#one_result_'+i).append("<div id='price_"+i+"'></div>");
            all_carrier_code = [];
            all_carrier_name = "";
            all_flight_number = "";
            $.each(h['slice'][0]['segment'], function(index, value){
              connection_duration = value['connectionDuration'];
              all_carrier_code.push(value['flight']['carrier']);
              if (!all_carrier_name.includes(carrier_name[all_carrier_code[index]])) {
                all_carrier_name += carrier_name[all_carrier_code[index]]+", ";
              };
              all_flight_number += all_carrier_code[index]+" "+value['flight']['number']+", ";
              if (index == (h['slice'][0]['segment'].length - 1)){
                stop_location = value['leg'][0]['origin'];
                final_destination = value['leg'][0]["destination"];
                flight_arrival_time_to = new Date(value['leg'][0]["arrivalTime"]).toLocaleTimeString().slice(0, -3);
                $('#time_'+i).append("<p>"+flight_departure_time+" - "+flight_arrival_time_to+"</p><p>"+all_carrier_name.slice(0, -2)+"</p>");
                $('#duration_'+i).append("<p>"+flight_duration+"</p><p>"+origin+" - "+final_destination+"</p>");
                $('#stops_'+i).append("<p>"+stops+"</p><p>"+stop_location+"</p>");
              };
            });
            $('#price_'+i).append("<p>"+total_price+"</p>");
          } else {
            stops = connection+" stops";
            $('#search_result_one_flight').append("<div id='one_result_"+i+"' class='one_result'></div>");
            $('#one_result_'+i).append("<div id='time_"+i+"'></div>");
            $('#one_result_'+i).append("<div id='duration_"+i+"'></div>");
            $('#one_result_'+i).append("<div id='stops_"+i+"'></div>");
            $('#one_result_'+i).append("<div id='price_"+i+"'></div>");
            all_carrier_code = [];
            all_carrier_name = "";
            all_flight_number = "";
            $.each(h['slice'][0]['segment'], function(index, value){
              connection_duration = value['connectionDuration'];
              all_carrier_code.push(value['flight']['carrier']);
              if (!all_carrier_name.includes(carrier_name[all_carrier_code[index]])) {
                all_carrier_name += carrier_name[all_carrier_code[index]]+", ";
              };
              all_flight_number += all_carrier_code[index]+" "+value['flight']['number']+", ";
              if (index == (h['slice'][0]['segment'].length - 1)){
                final_destination = value['leg'][0]["destination"];
                flight_arrival_time_to = new Date(value['leg'][0]["arrivalTime"]).toLocaleTimeString().slice(0, -3);
                $('#time_'+i).append("<p>"+flight_departure_time+" - "+flight_arrival_time_to+"</p><p>"+all_carrier_name.slice(0, -2)+"</p>");
                $('#duration_'+i).append("<p>"+flight_duration+"</p><p>"+origin+" - "+final_destination+"</p>");
                $('#stops_'+i).append("<p>"+stops+"</p><p>"+all_flight_number.slice(0, -2)+"</p>");
              };
            });
            $('#price_'+i).append("<p>"+total_price+"</p>");
          }

          debugger
        })
      }

    })
  })
})
